<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŒ‡æ•°ä¼°å€¼è¿½è¸ª (åŠ¨æ€æ‰©å®¹ç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; -webkit-font-smoothing: antialiased; }
        .metric-badge { font-size: 0.7rem; padding: 1px 5px; border-radius: 4px; font-weight: 600; white-space: nowrap; }
        .metric-pe { background-color: #e6f7ff; color: #096dd9; border: 1px solid #91d5ff; } 
        .metric-pb { background-color: #fff0f6; color: #c41d7f; border: 1px solid #ffadd2; } 
        .metric-ps { background-color: #f9f0ff; color: #531dab; border: 1px solid #d3adf7; } 
        .metric-ey { background-color: #f6ffed; color: #389e0d; border: 1px solid #b7eb8f; } 
        .spinner { border: 3px solid rgba(0,0,0,0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #2563eb; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .star-btn { transition: transform 0.2s; }
        .star-btn:active { transform: scale(1.3); }
        .tab-active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .tab-inactive { background-color: white; color: #4b5563; border-color: #e5e7eb; }
        th, td { white-space: nowrap; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .z-modal { z-index: 50; }
        .z-loader { z-index: 60; }
        
        /* æ–°å¢æ ‡ç­¾åŠ¨ç”» */
        .new-tag { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="app" class="container mx-auto p-3 max-w-[1600px] pb-20">
    
    <!-- é¡¶éƒ¨ -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-4 border border-gray-100 sticky top-0 z-30">
        <div class="flex flex-col gap-3">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <span class="text-xl">ğŸ“Š</span> ä¼°å€¼è¿½è¸ª
                        <span class="text-[10px] bg-red-50 text-red-600 px-1.5 py-0.5 rounded border border-red-200">åŠ¨æ€æ‰©å®¹</span>
                    </h1>
                    <p class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                        ğŸ“… æœ€æ–°æ‰¹æ¬¡: <span class="font-mono font-bold text-blue-600 bg-blue-50 px-1 rounded">{{ globalLastDate || 'æ— è®°å½•' }}</span>
                    </p>
                </div>
                <button @click="showConfig = true" class="text-gray-400 hover:text-gray-600 border p-1 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>

            <div class="flex gap-2">
                <label class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg shadow-md cursor-pointer text-sm font-bold flex items-center justify-center gap-2 transition active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    <span>ä¸Šä¼ æˆªå›¾ (æ”¯æŒæ–°å¢/ç•™å­˜)</span>
                    <input type="file" @change="handleImageUploadAI" accept="image/*" class="hidden">
                </label>
            </div>
            
            <div class="flex items-center justify-between gap-2">
                <div class="flex rounded-lg shadow-sm bg-gray-100 p-1">
                    <button @click="currentTab = 'all'" :class="['px-3 py-1.5 text-xs font-bold rounded transition', currentTab === 'all' ? 'bg-white text-blue-600 shadow' : 'text-gray-500']">å…¨éƒ¨ <span class="ml-0.5 opacity-60">{{ list.length }}</span></button>
                    <button @click="currentTab = 'starred'" :class="['px-3 py-1.5 text-xs font-bold rounded transition', currentTab === 'starred' ? 'bg-white text-amber-500 shadow' : 'text-gray-500']">â­ å…³æ³¨ <span class="ml-0.5 opacity-60">{{ starredCount }}</span></button>
                </div>
                <input v-model="searchQuery" type="text" placeholder="æœä»£ç /åç§°..." class="flex-1 min-w-0 bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 text-xs focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
        </div>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto no-scrollbar">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-3 text-center sticky left-0 bg-gray-50 z-20 w-8 border-r border-gray-200/50">â­</th>
                        <th class="px-3 py-3 text-left font-bold text-gray-700 sticky left-8 bg-gray-50 z-20 border-r border-gray-200 shadow-sm">åç§°</th>
                        <th class="px-2 py-3 text-left font-medium text-gray-500">æŒ‡æ ‡</th>
                        <th class="px-3 py-3 text-right font-black text-blue-700 bg-blue-50/50 border-l border-blue-100">å½“å‰</th>
                        <th class="px-2 py-3 text-center font-bold text-gray-600 bg-blue-50/30">çŠ¶æ€</th>
                        <th class="px-2 py-3 text-right text-xs text-gray-400 border-l">æœ€ä½</th>
                        <th class="px-2 py-3 text-right font-bold text-green-700 bg-green-50/30">ä½ä¼°çº¿</th>
                        <th class="px-2 py-3 text-right font-bold text-orange-700 bg-orange-50/30">é«˜ä¼°çº¿</th>
                        <th class="px-2 py-3 text-right text-xs text-gray-400">æœ€é«˜</th>
                        <th class="px-2 py-3 text-right text-xs text-gray-500 border-l">è·æœ€ä½</th>
                        <th class="px-2 py-3 text-right text-xs text-gray-500 bg-green-50/20">è·ä½ä¼°</th>
                        <th class="px-2 py-3 text-right text-xs text-gray-500 bg-orange-50/20">è·é«˜ä¼°</th>
                        <th class="px-2 py-3 text-right text-xs text-gray-500">è·æœ€é«˜</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-for="item in enrichedList" :key="item.code" class="hover:bg-gray-50 transition group text-xs sm:text-sm">
                        <td class="px-2 py-2.5 text-center sticky left-0 bg-white group-hover:bg-gray-50 z-20 border-r border-gray-100 cursor-pointer" @click="toggleStar(item)">
                            <span class="star-btn text-base block">{{ item.isStarred ? 'â­' : 'â˜†' }}</span>
                        </td>
                        <td class="px-3 py-2.5 sticky left-8 bg-white group-hover:bg-gray-50 z-20 border-r border-gray-200 shadow-sm">
                            <div class="flex items-center gap-1">
                                <div class="font-bold text-gray-800 truncate max-w-[80px] sm:max-w-none">{{ item.name }}</div>
                                <!-- ğŸ”´ åŠŸèƒ½1ï¼šå¦‚æœæ˜¯æ–°å¢çš„ï¼Œæ˜¾ç¤º[æ–°] -->
                                <span v-if="item.isNew" class="new-tag text-[8px] bg-red-100 text-red-600 px-1 rounded border border-red-200">æ–°</span>
                            </div>
                            <div class="text-[10px] text-gray-400 font-mono scale-90 origin-left">{{ item.code }}</div>
                        </td>
                        <td class="px-2 py-2.5"><span :class="['metric-badge', getMetricClass(item.metric)]">{{ item.metric }}</span></td>
                        
                        <!-- ğŸ”´ åŠŸèƒ½2ï¼šå½“å‰å€¼ + è¿‡æœŸæ—¶é—´æç¤º -->
                        <td class="px-3 py-2.5 text-right font-bold text-blue-700 bg-blue-50/50 border-l border-blue-100 cursor-pointer" @click="manualEdit(item)">
                            <div>{{ item.currentVal ? item.currentVal.toFixed(2) : '-' }}</div>
                            <!-- å¦‚æœè¯¥è¡Œçš„æ—¶é—´ != å…¨å±€æœ€æ–°æ—¶é—´ï¼Œæ˜¾ç¤ºç°è‰²å°å­—æ—¥æœŸ -->
                            <div v-if="item.lastDate && item.lastDate !== globalLastDate" class="text-[9px] font-normal text-gray-400 mt-0.5 whitespace-nowrap">
                                {{ item.lastDate }}
                            </div>
                        </td>

                        <td class="px-2 py-2.5 text-center bg-blue-50/30">
                            <span v-if="item.status" :class="getStatusClass(item.status)">{{ item.status }}</span>
                        </td>
                        <td class="px-2 py-2.5 text-right text-gray-400 border-l">{{ item.min.toFixed(2) }}</td>
                        <td class="px-2 py-2.5 text-right font-medium text-green-700 bg-green-50/30">{{ item.low.toFixed(2) }}</td>
                        <td class="px-2 py-2.5 text-right font-medium text-orange-700 bg-orange-50/30">{{ item.high.toFixed(2) }}</td>
                        <td class="px-2 py-2.5 text-right text-gray-400">{{ item.max.toFixed(2) }}</td>
                        <td class="px-2 py-2.5 text-right font-mono text-gray-500 border-l" :class="getColor(item.distMin)">{{ formatPercent(item.distMin) }}</td>
                        <td class="px-2 py-2.5 text-right font-mono text-gray-500 bg-green-50/20" :class="getColor(item.distLow)">{{ formatPercent(item.distLow) }}</td>
                        <td class="px-2 py-2.5 text-right font-mono text-gray-500 bg-orange-50/20" :class="getColor(item.distHigh)">{{ formatPercent(item.distHigh) }}</td>
                        <td class="px-2 py-2.5 text-right font-mono text-gray-500" :class="getColor(item.distMax)">{{ formatPercent(item.distMax) }}</td>
                    </tr>
                    <tr v-if="enrichedList.length === 0">
                        <td colspan="13" class="px-4 py-10 text-center text-gray-400 bg-gray-50">
                            <div v-if="currentTab === 'starred'">æš‚æ— å…³æ³¨</div>
                            <div v-else>æ— æ•°æ®</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- é…ç½®å¼¹çª— -->
    <div v-if="showConfig" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-modal flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h2 class="text-lg font-bold mb-4">âš™ï¸ ä¸ªäººé…ç½®</h2>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">API Key</label>
                    <input v-model="tempApiKey" type="password" class="w-full border rounded px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">API URL</label>
                    <input v-model="tempBaseUrl" type="text" class="w-full border rounded px-3 py-2 text-xs font-mono text-gray-600">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Model (ä½¿ç”¨ Pro)</label>
                    <input v-model="tempModel" type="text" class="w-full border rounded px-3 py-2 text-sm font-bold text-purple-600 bg-purple-50">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-5">
                <button @click="showConfig = false" class="px-3 py-2 text-sm text-gray-500 bg-gray-100 rounded">å–æ¶ˆ</button>
                <button @click="saveConfig" class="px-3 py-2 text-sm bg-blue-600 text-white rounded font-bold">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½ä¸­é®ç½© -->
    <div v-if="isLoading" class="fixed inset-0 bg-white/95 z-loader flex flex-col items-center justify-center text-center">
        <div class="spinner w-8 h-8 border-4 border-gray-200 border-l-purple-600 mb-4"></div>
        <h3 class="text-lg font-bold text-gray-800">AI æ­£åœ¨å¤„ç†...</h3>
        <p class="text-xs text-gray-500 mt-1 max-w-[250px]">æ­£åœ¨æå–æ‰€æœ‰è¡Œæ•°æ®<br>æ¯”å¯¹æ–°å¢/ç¼ºå¤±...</p>
        <button @click="isLoading = false" class="mt-8 px-6 py-2 bg-red-50 text-red-600 rounded-full text-xs font-bold border border-red-100 hover:bg-red-100">
            âœ• å¼ºåˆ¶å–æ¶ˆ
        </button>
    </div>
</div>

<script>
    const { createApp } = Vue;

    const DEFAULT_CONFIG = {
        apiKey: "AIzaSyCkAkaFj2TIAlsy6-Yk90_WoMVydZYuhp0", 
        model: "gemini-1.5-pro", 
        baseUrl: "https://generativelanguage.googleapis.com" 
    };

    // åˆå§‹ç§å­æ•°æ® (54æ¡)
    const seedData = [
        {code: "930743", name: "ç”Ÿç‰©ç§‘æŠ€", metric: "å¸‚ç›ˆç‡", min: 33.00, low: 57.00, high: 81.00, max: 135.00, market: "Aè‚¡"},
        {code: "399989", name: "ä¸­è¯åŒ»ç–—", metric: "å¸‚ç›ˆç‡", min: 32.00, low: 55.00, high: 75.00, max: 140.00, market: "Aè‚¡"},
        {code: "931357", name: "æ²ªæ¸¯æ·±æ¶ˆè´¹50", metric: "å¸‚ç›ˆç‡", min: 25.00, low: 33.00, high: 42.00, max: 56.00, market: "Aè‚¡"},
        {code: "399997", name: "ä¸­è¯ç™½é…’", metric: "å¸‚ç›ˆç‡", min: 15.00, low: 30.00, high: 40.00, max: 71.00, market: "Aè‚¡"},
        {code: "000978", name: "åŒ»è¯100", metric: "å¸‚ç›ˆç‡", min: 23.00, low: 28.00, high: 36.00, max: 63.00, market: "Aè‚¡"},
        {code: "000932", name: "ä¸­è¯æ¶ˆè´¹", metric: "å¸‚ç›ˆç‡", min: 17.00, low: 30.00, high: 40.00, max: 53.00, market: "Aè‚¡"},
        {code: "930653", name: "é£Ÿå“é¥®æ–™", metric: "å¸‚ç›ˆç‡", min: 18.00, low: 30.00, high: 40.00, max: 65.00, market: "Aè‚¡"},
        {code: "931009", name: "å»ºç­‘ææ–™", metric: "å¸‚å‡€ç‡", min: 1.40, low: 1.80, high: 2.10, max: 3.10, market: "Aè‚¡"},
        {code: "931068", name: "æ¶ˆè´¹é¾™å¤´", metric: "å¸‚ç›ˆç‡", min: 16.00, low: 24.00, high: 32.00, max: 45.00, market: "Aè‚¡"},
        {code: "H30094", name: "æ¶ˆè´¹çº¢åˆ©", metric: "å¸‚ç›ˆç‡", min: 11.00, low: 25.00, high: 33.00, max: 45.00, market: "æ¸¯è‚¡"},
        {code: "HSTECH", name: "æ’ç”Ÿç§‘æŠ€", metric: "å¸‚é”€ç‡", min: 3.20, low: 4.00, high: 5.60, max: 9.00, market: "æ¸¯è‚¡"},
        {code: "H30533", name: "ä¸­æ¦‚äº’è”", metric: "å¸‚é”€ç‡", min: 3.20, low: 4.00, high: 5.60, max: 12.80, market: "æ¸¯è‚¡"},
        {code: "000919", name: "300ä»·å€¼", metric: "ç›ˆåˆ©æ”¶ç›Šç‡", min: 16.60, low: 10.00, high: 6.40, max: 2.22, market: "Aè‚¡"},
        {code: "000922", name: "ä¸­è¯çº¢åˆ©", metric: "ç›ˆåˆ©æ”¶ç›Šç‡", min: 16.60, low: 10.00, high: 6.40, max: 1.60, market: "Aè‚¡"},
        {code: "399324", name: "æ·±çº¢åˆ©", metric: "å¸‚ç›ˆç‡", min: 11.00, low: 15.00, high: 22.00, max: 44.00, market: "Aè‚¡"},
        {code: "SPG120035", name: "å…¨çƒåŒ»ç–—", metric: "å¸‚ç›ˆç‡", min: 15.00, low: 21.00, high: 30.00, max: 45.00, market: "ç¾è‚¡"},
        {code: "707717", name: "MSCIè´¨é‡", metric: "å¸‚ç›ˆç‡", min: 17.00, low: 26.00, high: 38.00, max: 55.00, market: "ç¾è‚¡"},
        {code: "CSPSADRP", name: "çº¢åˆ©æœºä¼š", metric: "å¸‚ç›ˆç‡", min: 8.00, low: 13.00, high: 20.00, max: 30.00, market: "ç¾è‚¡"},
        {code: "000015", name: "ä¸Šè¯çº¢åˆ©", metric: "ç›ˆåˆ©æ”¶ç›Šç‡", min: 17.50, low: 10.00, high: 6.40, max: 2.27, market: "Aè‚¡"},
        {code: "000905", name: "500å¢å¼º", metric: "å¸‚ç›ˆç‡", min: 17.00, low: 25.00, high: 40.00, max: 93.00, market: "Aè‚¡"},
        {code: "930782", name: "500ä½æ³¢åŠ¨", metric: "å¸‚ç›ˆç‡", min: 17.00, low: 24.00, high: 30.00, max: 60.00, market: "Aè‚¡"},
        {code: "000989", name: "å¯é€‰æ¶ˆè´¹", metric: "å¸‚ç›ˆç‡", min: 15.00, low: 18.00, high: 26.00, max: 45.00, market: "Aè‚¡"},
        {code: "000906", name: "ä¸­è¯800", metric: "å¸‚ç›ˆç‡", min: 9.00, low: 15.00, high: 19.00, max: 52.00, market: "Aè‚¡"},
        {code: "399975", name: "è¯åˆ¸è¡Œä¸š", metric: "å¸‚å‡€ç‡", min: 1.05, low: 1.60, high: 2.20, max: 4.80, market: "Aè‚¡"},
        {code: "000925", name: "åŸºæœ¬é¢50", metric: "ç›ˆåˆ©æ”¶ç›Šç‡", min: 16.60, low: 10.00, high: 6.40, max: 2.22, market: "Aè‚¡"},
        {code: "IXY", name: "ç¾è‚¡æ¶ˆè´¹", metric: "å¸‚ç›ˆç‡", min: 15.00, low: 21.00, high: 30.00, max: 45.00, market: "ç¾è‚¡"},
        {code: "399995", name: "åŸºå»ºè¡Œä¸š", metric: "å¸‚å‡€ç‡", min: 0.92, low: 1.10, high: 1.80, max: 3.60, market: "Aè‚¡"},
        {code: "S5INFT", name: "æ ‡æ™®ç§‘æŠ€", metric: "å¸‚ç›ˆç‡", min: 15.00, low: 21.00, high: 30.00, max: 90.00, market: "ç¾è‚¡"},
        {code: "930697", name: "å®¶ç”¨ç”µå™¨", metric: "å¸‚ç›ˆç‡", min: 12.00, low: 17.00, high: 20.00, max: 28.00, market: "Aè‚¡"},
        {code: "931142", name: "ç«äº‰åŠ›æŒ‡æ•°", metric: "å¸‚ç›ˆç‡", min: 10.00, low: 13.00, high: 18.00, max: 23.00, market: "Aè‚¡"},
        {code: "950090", name: "50AHä¼˜é€‰", metric: "ç›ˆåˆ©æ”¶ç›Šç‡", min: 16.60, low: 10.00, high: 6.40, max: 2.22, market: "æ¸¯è‚¡"},
        {code: "399393", name: "åœ°äº§è¡Œä¸š", metric: "å¸‚å‡€ç‡", min: 1.20, low: 1.60, high: 2.20, max: 4.00, market: "Aè‚¡"},
        {code: "000300", name: "æ²ªæ·±300", metric: "å¸‚ç›ˆç‡", min: 8.00, low: 12.00, high: 17.00, max: 49.00, market: "Aè‚¡"},
        {code: "000852", name: "ä¸­è¯1000", metric: "å¸‚ç›ˆç‡", min: 19.00, low: 35.00, high: 48.00, max: 145.00, market: "Aè‚¡"},
        {code: "399006", name: "åˆ›ä¸šæ¿", metric: "å¸‚ç›ˆç‡", min: 18.00, low: 25.00, high: 45.00, max: 138.00, market: "Aè‚¡"},
        {code: "HSI", name: "æ’ç”ŸæŒ‡æ•°", metric: "ç›ˆåˆ©æ”¶ç›Šç‡", min: 14.50, low: 10.00, high: 6.40, max: 4.76, market: "æ¸¯è‚¡"},
        {code: "000016", name: "ä¸Šè¯50", metric: "ç›ˆåˆ©æ”¶ç›Šç‡", min: 14.50, low: 10.00, high: 6.40, max: 2.22, market: "Aè‚¡"},
        {code: "HSCEI", name: "Hè‚¡æŒ‡æ•°", metric: "ç›ˆåˆ©æ”¶ç›Šç‡", min: 17.50, low: 10.00, high: 6.40, max: 3.45, market: "æ¸¯è‚¡"},
        {code: "399812", name: "ä¸­è¯å…»è€", metric: "å¸‚ç›ˆç‡", min: 17.00, low: 21.00, high: 27.00, max: 36.00, market: "Aè‚¡"},
        {code: "931187", name: "ç§‘æŠ€100", metric: "å¸‚ç›ˆç‡", min: 18.00, low: 26.00, high: 40.00, max: 56.00, market: "Aè‚¡"},
        {code: "399550", name: "å¤®è§†50", metric: "ç›ˆåˆ©æ”¶ç›Šç‡", min: 16.60, low: 10.00, high: 6.40, max: 2.50, market: "Aè‚¡"},
        {code: "399967", name: "å†›å·¥è¡Œä¸š", metric: "å¸‚å‡€ç‡", min: 2.10, low: 2.60, high: 4.00, max: 9.20, market: "Aè‚¡"},
        {code: "NDX", name: "çº³æ–¯è¾¾å…‹100", metric: "å¸‚ç›ˆç‡", min: 15.00, low: 20.00, high: 30.00, max: 85.00, market: "ç¾è‚¡"},
        {code: "399986", name: "é“¶è¡Œè¡Œä¸š", metric: "å¸‚å‡€ç‡", min: 0.75, low: 0.90, high: 1.15, max: 1.40, market: "Aè‚¡"},
        {code: "SPX", name: "æ ‡æ™®500", metric: "å¸‚ç›ˆç‡", min: 5.80, low: 15.00, high: 25.00, max: 44.00, market: "ç¾è‚¡"},
        {code: "000010", name: "ä¸Šè¯180", metric: "ç›ˆåˆ©æ”¶ç›Šç‡", min: 13.90, low: 10.00, high: 6.40, max: 2.17, market: "Aè‚¡"},
        {code: "000827", name: "ç¯ä¿è¡Œä¸š", metric: "å¸‚å‡€ç‡", min: 1.82, low: 2.30, high: 3.00, max: 5.90, market: "Aè‚¡"},
        {code: "399702", name: "åŸºæœ¬é¢120", metric: "å¸‚ç›ˆç‡", min: 13.00, low: 18.00, high: 22.00, max: 60.00, market: "Aè‚¡"},
        {code: "399701", name: "åŸºæœ¬é¢60", metric: "å¸‚ç›ˆç‡", min: 12.00, low: 17.00, high: 20.00, max: 60.00, market: "Aè‚¡"},
        {code: "399330", name: "æ·±è¯100", metric: "å¸‚ç›ˆç‡", min: 12.00, low: 18.00, high: 24.00, max: 64.00, market: "Aè‚¡"},
        {code: "399001", name: "æ·±è¯æˆæŒ‡", metric: "å¸‚ç›ˆç‡", min: 11.00, low: 15.00, high: 30.00, max: 62.00, market: "Aè‚¡"},
        {code: "000903", name: "ä¸­è¯100", metric: "å¸‚ç›ˆç‡", min: 7.00, low: 11.00, high: 15.00, max: 45.00, market: "Aè‚¡"},
        {code: "SPHCMSHP", name: "é¦™æ¸¯ä¸­å°", metric: "å¸‚ç›ˆç‡", min: 8.40, low: 12.00, high: 17.00, max: 20.00, market: "æ¸¯è‚¡"},
        {code: "000688", name: "ç§‘åˆ›50", metric: "å¸‚ç›ˆç‡", min: 35.00, low: 50.00, high: 80.00, max: 100.00, market: "Aè‚¡"},
        {code: "HSCAIT", name: "Aè‚¡é¾™å¤´", metric: "å¸‚ç›ˆç‡", min: 8.00, low: 11.00, high: 13.00, max: 15.00, market: "æ¸¯è‚¡"}
    ];

    createApp({
        data() {
            return {
                list: [], searchQuery: '', currentTab: 'all', showConfig: false, 
                isLoading: false, 
                globalLastDate: '', // âš ï¸ å…¨å±€æœ€æ–°æ‰¹æ¬¡æ—¥æœŸ
                
                apiKey: localStorage.getItem('val_key_diag') || DEFAULT_CONFIG.apiKey,
                model: localStorage.getItem('val_model_diag') || DEFAULT_CONFIG.model,
                baseUrl: localStorage.getItem('val_url_diag') || DEFAULT_CONFIG.baseUrl,
                tempApiKey: '', tempModel: '', tempBaseUrl: ''
            }
        },
        mounted() {
            this.isLoading = false; 
            this.loadData();
            this.tempApiKey = this.apiKey; this.tempModel = this.model; this.tempBaseUrl = this.baseUrl;
            if(!this.apiKey) setTimeout(() => this.showConfig = true, 500);
        },
        computed: {
            starredCount() { return this.list.filter(i => i.isStarred).length; },
            enrichedList() {
                let tabFiltered = this.list;
                if (this.currentTab === 'starred') tabFiltered = this.list.filter(item => item.isStarred);
                let result = tabFiltered.filter(item => 
                    item.name.toLowerCase().includes(this.searchQuery.toLowerCase()) || 
                    item.code.toLowerCase().includes(this.searchQuery.toLowerCase())
                );
                return result.map(item => {
                    const val = item.currentVal;
                    // å¦‚æœæ²¡æœ‰å½“å‰å€¼ï¼Œè¿”å›ç©ºçŠ¶æ€
                    if (val === undefined || val === null) return { ...item, status: '-' };
                    
                    const isInverse = item.metric === 'ç›ˆåˆ©æ”¶ç›Šç‡';
                    let status = 'æ­£å¸¸';
                    let distMin, distLow, distHigh, distMax;
                    
                    // çŠ¶æ€è®¡ç®—é€»è¾‘
                    if (!isInverse) {
                        if (val < item.low) status = 'ä½ä¼°'; else if (val > item.high) status = 'é«˜ä¼°';
                        distMin = (item.min - val) / val; distLow = (item.low - val) / val;
                        distHigh = (item.high - val) / val; distMax = (item.max - val) / val;
                    } else {
                        if (val > item.low) status = 'ä½ä¼°'; else if (val < item.high) status = 'é«˜ä¼°';
                        distMin = (val - item.min) / val; distLow = (val - item.low) / val;
                        distHigh = (val - item.high) / val; distMax = (val - item.max) / val;
                    }
                    
                    return { ...item, status, distMin, distLow, distHigh, distMax };
                });
            }
        },
        methods: {
            toggleStar(item) {
                const originalItem = this.list.find(i => i.code === item.code);
                if (originalItem) { originalItem.isStarred = !originalItem.isStarred; this.saveData(); }
            },
            async handleImageUploadAI(event) {
                const file = event.target.files[0];
                if (!file) return;
                if (!this.apiKey) { this.showConfig = true; return; }
                this.isLoading = true; 
                try {
                    const base64Image = await this.fileToBase64(file);
                    const cleanBase64 = base64Image.split(',')[1];
                    let baseUrl = this.baseUrl.replace(/\/+$/, '');
                    let modelName = this.model.replace('models/', '');
                    const realMimeType = file.type || "image/jpeg";
                    const url = `${baseUrl}/v1beta/models/${modelName}:generateContent?key=${this.apiKey}`;
                    
                    // ğŸš€ è¶…å¼º Promptï¼šæ”¯æŒæ–°å¢æ•°æ®æå–
                    const promptText = `
                        Analyze this stock valuation table strictly.
                        
                        Task 1: Identify the Header Date (e.g., 20251126).
                        
                        Task 2: Extract ALL rows. For EACH row, extract:
                        - Code (e.g. 930743)
                        - Name
                        - Metric (Search for 'å¸‚ç›ˆç‡', 'å¸‚å‡€ç‡', 'å¸‚é”€ç‡', 'ç›ˆåˆ©æ”¶ç›Šç‡'. If not found, use context)
                        - Min (æœ€ä½)
                        - Low (ä½ä¼°)
                        - High (é«˜ä¼°)
                        - Max (æœ€é«˜)
                        - Current Value (The number in the column under the Date header)
                        
                        Return JSON:
                        {
                            "date": "YYYY-MM-DD",
                            "items": [ 
                                {
                                    "code": "...", "name": "...", "metric": "...", 
                                    "min": 1.1, "low": 2.2, "high": 3.3, "max": 4.4, "current": 2.5
                                }, 
                                ... 
                            ]
                        }
                    `;

                    const payload = {
                        contents: [{ parts: [
                            { text: promptText },
                            { inline_data: { mime_type: realMimeType, data: cleanBase64 } }
                        ]}]
                    };
                    
                    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!res.ok) { const err = await res.json(); throw new Error(err.error?.message || `API Error ${res.status}`); }
                    
                    const data = await res.json();
                    const text = data.candidates[0].content.parts[0].text;
                    const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const result = JSON.parse(jsonStr); 

                    const extractedItems = Array.isArray(result) ? result : (result.items || []);
                    const extractedDate = result.date || new Date().toISOString().split('T')[0];

                    let updateCount = 0;
                    let newCount = 0;

                    // âš¡ï¸ æ ¸å¿ƒé€»è¾‘ï¼šåˆå¹¶æ•°æ®
                    extractedItems.forEach(aiItem => {
                        // 1. å°è¯•åŒ¹é…ç°æœ‰æ•°æ®
                        let existingItem = this.list.find(l => l.code == aiItem.code);
                        if (!existingItem && aiItem.name) {
                            existingItem = this.list.find(l => l.name.includes(aiItem.name) || aiItem.name.includes(l.name));
                        }

                        if (existingItem) {
                            // æ›´æ–°è€æ•°æ®
                            if (aiItem.current) {
                                existingItem.currentVal = parseFloat(aiItem.current);
                                existingItem.lastDate = extractedDate; // æ ‡è®°è¯¥è¡Œæ›´æ–°æ—¶é—´
                                updateCount++;
                            }
                        } else {
                            // âœ¨ å‘ç°æ–°æ•°æ® -> æ’å…¥åˆ—è¡¨
                            if (aiItem.code && aiItem.current) {
                                this.list.push({
                                    code: aiItem.code,
                                    name: aiItem.name,
                                    metric: aiItem.metric || 'å¸‚ç›ˆç‡', // é»˜è®¤å€¼é˜²é”™
                                    min: parseFloat(aiItem.min) || 0,
                                    low: parseFloat(aiItem.low) || 0,
                                    high: parseFloat(aiItem.high) || 0,
                                    max: parseFloat(aiItem.max) || 0,
                                    currentVal: parseFloat(aiItem.current),
                                    lastDate: extractedDate,
                                    isNew: true, // æ ‡è®°ä¸ºæ–°
                                    isStarred: false,
                                    market: "æœªçŸ¥" // AIæ²¡æ³•åˆ¤æ–­å¸‚åœºï¼Œå…ˆç»™ä¸ªé»˜è®¤
                                });
                                newCount++;
                            }
                        }
                    });
                    
                    this.globalLastDate = extractedDate;
                    this.saveData(); 
                    alert(`âœ… å¤„ç†å®Œæˆï¼\nğŸ“… æ—¥æœŸ: ${extractedDate}\nğŸ”„ æ›´æ–°æ—§æ•°æ®: ${updateCount} æ¡\nâœ¨ æ–°å¢æ•°æ®: ${newCount} æ¡`);
                } catch (err) { alert(`è¯†åˆ«å¤±è´¥: ${err.message}`); this.showConfig = true; } finally { this.isLoading = false; event.target.value = ''; }
            },
            loadData() {
                const stored = localStorage.getItem('val_data_v2'); // å‡çº§äº†keyé˜²æ­¢å†²çª
                if (stored) { 
                    const parsed = JSON.parse(stored);
                    this.list = parsed.list || [];
                    this.globalLastDate = parsed.globalLastDate || '';
                } else { 
                    this.list = JSON.parse(JSON.stringify(seedData)); 
                    this.saveData(); 
                }
            },
            saveData() {
                const payload = {
                    list: this.list,
                    globalLastDate: this.globalLastDate
                };
                localStorage.setItem('val_data_v2', JSON.stringify(payload));
            },
            saveConfig() {
                this.apiKey = this.tempApiKey; this.model = this.tempModel; this.baseUrl = this.tempBaseUrl;
                localStorage.setItem('val_key_diag', this.apiKey);
                localStorage.setItem('val_model_diag', this.model);
                localStorage.setItem('val_url_diag', this.baseUrl);
                this.showConfig = false;
            },
            resetData() { if(confirm('é‡ç½®æ•°æ®ï¼Ÿ')) { this.list = JSON.parse(JSON.stringify(seedData)); this.globalLastDate = ''; this.saveData(); } },
            manualEdit(item) { const v = prompt(`ä¿®æ”¹ ${item.name} å½“å‰å€¼:`, item.currentVal || ''); if (v && !isNaN(v)) { item.currentVal = parseFloat(v); item.lastDate = this.globalLastDate; this.saveData(); } },
            fileToBase64(file) { return new Promise((r, j) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => r(reader.result); reader.onerror = j; }); },
            getMetricClass(m) { if(m==='å¸‚ç›ˆç‡')return'metric-pe';if(m==='å¸‚å‡€ç‡')return'metric-pb';if(m==='å¸‚é”€ç‡')return'metric-ps';return'metric-ey'; },
            getStatusClass(s) { if(s==='ä½ä¼°')return'text-green-600 bg-green-100 font-bold px-2 rounded text-[10px]';if(s==='é«˜ä¼°')return'text-red-600 bg-red-100 font-bold px-2 rounded text-[10px]';return'text-orange-500 bg-orange-50 px-2 rounded text-[10px]'; },
            getColor(v) { if(v==null)return''; return v>=0?'text-green-600':'text-red-400'; },
            formatPercent(v) { if(v==null)return'-'; return (v*100).toFixed(2)+'%'; }
        }
    }).mount('#app');
</script>
</body>
</html>